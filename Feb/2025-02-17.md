## 1번. Kubernetes 실습

### 쿠버네티스 API

- 쿠버네티스 조작은 모두 API로 동작한다.
- CLI kubectl을 통해 마스터 노드 kube-apiserver에게 yaml 혹은 json 형식으로 전송

### 오브젝트

- 오브젝트 생성 시 같은 종류의 네임스페이스에서 반드시 유일해야 함
- 쿠버네티스 API의 리소스 종류에 맞게 설정 및 생성

### 워크로드

- 컨테이너, 파드, 컨트롤러의 그룹을 의미
- 컨테이너의 실행을 관리하기 위해 사용

### 파드

- 컨테이너를 실행하기 위한 오브젝트
- 한 개 또는 여러 개의 컨테이너를 관리함 → 컨테이너를 부품처럼 조립함
- 파드의 볼륨을 마운트하여 파일 시스템 공유 가능
- 파드의 IP주소와 포트번호를 공유하며 localhost로 서로 통신할 수 있음. 단, 삭제될 때 다시 회수된다.
- 생성 시 서브넷 영역을 넓게 설정해야 한다.
- 파드에 요청을 보낼 때는 반드시 서비스 오브젝트를 사용해야 한다.
- 파드끼리 통신할 땐 busybox를 사용한다.

### 컨트롤러

- 파드를 제어하는 오브젝트
- 서버-클라이언트 모뎅레 적합한 디플로이먼트 컨트롤러의 경우, 파드의 지정된 개수를 유지.
- 배치 처리에 적합한 컨트롤러는 배치 처리가 정상 종료될 때까지 재실행이 반복됨
- 디플로이먼트(롤링업데이트, 재생성), 스테이트 풀셋, 잡, 크론잡, 데몬셋, 레플리카셋

**디플로이먼트**

- 여러 파드로 수평 구조의 클러스터를 구성할 때 사용
- 라벨과 셀렉터를 통해 파드 객체를 확인
- 가동 중인 파드를 차례대로 교체(롤링업데이트, 재생성)하거나 규모를 조절할 수 있는 기능 제어

**스테이트 풀셋**

- 파드와 퍼시스턴트 볼륨을 조합하여 데이터의 보관에 초점을 둔 컨트롤러

**잡**

- 배치 처리를 하는 컨테이너가 정상 종료할 때까지 재실행을 반복하는 컨트롤러
- 모든 로그는 파드를 삭제할 때까지 보존

**크론잡**

- 지정한 시간에 정기적으로 잡을 생성한다.

**데몬셋**

- 클러스터의 모든 노드에서 동일한 파드를 실행하기 위해 존재
- 네트워크 구성 파드는 데몬셋에 의해 모든 노드에서 실행

**레플리카셋**

- 디플로이먼트 컨트롤러와 연동해서 가동하는 파드의 수를 관리

| 프론트엔드 처리(워크로드 타입) | 백엔드 처리(워크로드 타입) |
| --- | --- |
| 클라이언트의 요청을 직접 받음 | 데이터의 보존과 조회 기능 |
| 요청에 대응하는 처리를 복수의 파드에서 분단하도록 설계 | 캐시: 복수 파드에서 데이터 공유(세션 정보 공유 등) |
| 24시간 무중단 배포 | 메시징: 비동기 시스템 간 연계 기능<br>마이크로서비스: 전문적 업무 기능 구현(조회, 구매, 등등)<br>배치 처리: 긴 처리 시간을 요하는 업무 기능 |

![controllers.png](/media/Kubernetes-controllers.png)

### 클러스터 네트워크

**Flannel**

- 간단한 L3 네트워크를 노드 간에 구축
- 네트워크 기능만 갖춤

**Calico**

- 노드 간 파드 통신에 네트워크 접근 제어 기능을 추가 제공
- 2개의 네임스페이스 간 통신을 금지하는 **접근 제어 기능**을 설정 가능

**서비스 기본 및 동작 순서**

- 파드의 IP 주소가 기동될 때마다 변경되기 때문에 서비스가 가지는 대표 IP를 이용해 접근
- 내부 DNS → 대표 IP → 셀렉터에 지정된 라벨에 일치하는 파드로 접근 → 서비스가 만들어진 후 생성된 컨테이너는 환경변수가 자동으로 설정됨

- **설정**: ConfigMap 또는 Secret 오브젝트를 사용,네임스페이스에 저장된 환경변수를 통해 참조

### 서비스

- 파드와 클라이언트를 연결하는 역할을 수행
- 파드의 대표 IP를 내부 DNS에 등록한다
- 셀렉터와 디플로이먼트 파드 템플릿의 metadata.label에 같은 값을 설정하고, 셀렉터의 라벨과 일치하는 파드를 etcd로부터 선택한다.

**ClusterIP**

- 타입을 지정하지 않으면 기본적으로 생성하는 디폴트 서비스
- 내부에서 내부 DNS에 등록한 이름으로 파드 집합에 요청 전송을 한다. busybox를 이용한다.
- 유저 → LB → 서비스로 접속

**NodePort**

- ClusterIP의 접근 범위뿐만 아리아 k8s 클러스터 외부에서도 노드의 IP 주소와 포트 번호로 접근할 수 있다.
- ClusterIP의 기능에 더해 공개 포트가 오픈된다(30000~32767)

**Load Balancer**

- NodePort를 사용하기 때문에 ClusterIP도 자동할당 된다.

**External Name**

- 파드에서 k8s 클러스터로 외부의 엔드포인트에 접속하기 위한 이름을 해결
- 서비스명과 외부 DNS 주소를 등록 또는 삭제

**job과 cron job**

- job controller: 모든 컨테이너가 정상적으로 종료할 때까지 재실행한다.
    - 일괄 처리 타입의 워크로드에 적합
    - 비정상 종료에 따른 재실행 횟수 도달 시 종료
- cron job: UNIX의 크론과 같은 포맷으로 실행 스케줄을 지정할 수 있는 컨트롤러
    - 정기적으로 잡을 실행할 때 적합
- **동시 실행과 순차 실행**
    - 복수의 노드 위에서 여러 파드를 동시에 실행하여 배치 처리를 빠르게 완료할 수 있다
- 파드를 실행할 노드 선택
- 온라인 배치 처리 요청
- 메시지 브로커와의 조합

![services.png](/media/Kubernetes-services.png)

### 스토리지

- 추상화된 스토리지를 컨테이너에 마운트
- 퍼시스선트 볼륨(외부 스토리지)를 사용해 다른 노드의 컨테이너와 연계, 동시 사용이 가능하다.
- API를 사용하여 볼륨을 자동으로 준비해주는 방법(동적)
- 외부 스토리지 시스템의 설정을 직접 진행하는 방법(수동)

### 인그레스

- 서비스와 연결하여 애플리케이션을 공개
    - SSL/TLS 암호화난 세션 어피니티 기능을 갖추고 있어 쿠버네티스화 하는데 유용한 오브젝트
    - 기존 로드밸런서 대체 가능
        - 복수의 도메인 이름을 가지는 가상 호스트 가능
        - 클라이언트의 요청을 여러 파드에 분산

### 오토스케일

- CPU와 메모리 사용률 등 부하에 반응해 자동으로 처리 능력 조절
- 비용 최적화 효과가 있다.
